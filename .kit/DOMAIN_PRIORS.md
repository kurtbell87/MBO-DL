# Domain Priors — MES Microstructure

Knowledge injected by the research lead. The SURVEY and FRAME agents
MUST read this file and incorporate these priors into experiment design.

## Problem Structure

- **Instrument**: MES (Micro E-mini S&P 500 futures) on CME Globex (MDP3).
- **Tick size**: 0.25 index points ($1.25 per tick per contract).
- **Data schema**: Databento MBO (Market By Order / L3). Per-order events: Add, Cancel, Modify, Trade, Fill, Clear. Keyed by `order_id`.
- **Source files**: `DATA/GLBX-20260207-L953CAPU5B/glbx-mdp3-YYYYMMDD.mbo.dbn.zst` — 312 daily files covering all of 2022 (~49 GB total).
- **Recommended dev file**: `glbx-mdp3-20220103.mbo.dbn.zst` (first full RTH day of 2022).
- **Instrument IDs**: MESM2 = `13615` (Mar 2022 front month, Q1-Q2), MESU2 = `10039` (Sep 2022, Q3). See `DATA/symbology.json`.
- **Session times**: RTH = 09:30:00.000 ET through 16:00:00.000 ET.
- **Snapshot interval**: 100ms (10 snapshots/second).
- **Book depth**: L=10 price levels per side.
- **Trade buffer**: T=50 rolling trades, left-padded with zeros.
- **MBO price encoding**: Fixed-point `int64_t` with scale 1e-9. Convert: `float_price = static_cast<float>(price) / 1e9f`.

## Known Architecture-Problem Mappings

- **MLP**: Baseline. Flatten (600,194) → 116,400 inputs. Will overfit N=32 but may take 200-400 epochs due to gradient dilution. If >400 epochs without >95%, investigate pipeline.
- **SSM (Mamba)**: Best for temporal dynamics — sweep-then-reload, momentum sequences. Requires CUDA + Python.
- **CNN**: Treats (W,F) as 2D image. Good at local spatial patterns in the book.
- **GBT (XGBoost)**: Hand-crafted features (OFI, trade imbalance, spread dynamics). Different feature pipeline than neural models.

## Anti-Patterns to Avoid

- Don't tune hyperparameters for the overfit test — if N=32 doesn't memorize, the pipeline is broken, not the hyperparameters.
- Don't normalize across the full dataset — z-scores are per observation window (W=600 snapshots).
- Don't deduplicate trades in the feature encoder — only GBT hand-crafted features need deduplication.
- Don't use action masking in loss computation — the model must learn validity from the position_state feature.
- Don't process Fill events ('F') into the trade buffer — only Trade events ('T') count (prevents double-counting).

## Domain-Specific Guidance

- **C++ API**: Use `databento::DbnFileStore` to read `.dbn.zst` files. See `DATA/README.md` for includes and linking.
- **Build system**: CMake with FetchContent for dependencies (libtorch, databento-cpp, xgboost, GTest).
- **Feature dim**: 194 per snapshot. Index ranges defined as constants in `feature_encoder.hpp`.
- **Action space**: 5 discrete actions. REVERSE (4) is never generated by the oracle — exists only for future RL.
- **Oracle**: Stateless per call. `trajectory_builder` owns position state and `entry_price`.
- **Label distribution**: After subsampling N=32, verify at least 3 of 4 used classes present, no class >80%.
