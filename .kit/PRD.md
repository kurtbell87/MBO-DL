# MBO-DL — MES Microstructure Model Suite

## Product Requirements Document

---

## 1. Goal

Build four model architectures (MLP, SSM, CNN, GBT) that ingest MES limit order book data and output trading actions. Each model is trained to intentionally overfit on a small data slice (N=32-128 samples) to verify end-to-end correctness of: data pipeline, feature encoding, forward pass, loss computation, backward pass, and action decoding.

This is NOT about finding alpha. This is a correctness harness.

**Success metric:** All 4 models reach >95% accuracy on the N=32 overfit set. If a model cannot memorize 32 samples to near-zero loss, something is broken in the pipeline.

---

## 2. Constraints

| Constraint | Decision |
|------------|----------|
| Language   | C++20 (data pipeline, MLP/CNN/GBT inference), Python (SSM only — mamba-ssm requires CUDA) |
| Framework  | libtorch (MLP, CNN), xgboost C API (GBT), mamba-ssm 2.2 (SSM) |
| Testing    | GTest (C++ unit tests) |
| Build      | CMake |
| Data       | Databento MBO (L3), MES.FUT 2022, `DATA/GLBX-20260207-L953CAPU5B/` |

---

## 3. Non-Goals (v1)

- Live trading or paper trading
- RL reward optimization (future spec)
- Multi-instrument support (single front-month outright only)
- Production-grade latency optimization
- GPU training for MLP/CNN/GBT (CPU is fine for N=32 overfit)

---

## 4. Architecture

```
Raw MBO (.dbn.zst) → book_builder → BookSnapshot[W=600]
  → feature_encoder → (B, 600, 194)
  → trajectory_builder + oracle_labeler → (window, label) pairs
  → model.forward() → (B, 5) logits
  → cross_entropy_loss → backward → optimizer step
```

- **Data contract**: 5 actions (Hold=0, Enter Long=1, Enter Short=2, Exit=3, Reverse=4). Reverse never generated by oracle.
- **Feature dim**: 194 (10 bid prices + 10 bid sizes + 10 ask prices + 10 ask sizes + 50 trade prices + 50 trade sizes + 50 aggressor + spread + time_sin + time_cos + position_state)
- **Window**: W=600 snapshots (60s at 100ms), F=194 features

---

## 5. Build Order

| Step | Description | Status |
|------|-------------|--------|
| 1    | **Data Pipeline** — `book_builder`: MBO → BookSnapshot at 100ms. Read `.dbn.zst` via databento C++ API, reconstruct order book, emit snapshots during RTH (09:30-16:00 ET). | Not started |
| 2    | **Feature Encoder** — `feature_encoder`: BookSnapshot → (W, 194) tensor. Price deltas from mid in ticks, log1p sizes z-scored per window, sinusoidal time, position state injection. | Not started |
| 3    | **Oracle Labeler + Trajectory Builder** — Stateless oracle with forward lookahead (horizon=100, target=10 ticks, stop=5 ticks, TP=20 ticks). Trajectory builder manages position state and entry_price. | Not started |
| 4    | **MLP Model** — Flatten (B,600,194)→(B,116400), 3 hidden layers (512→256→128), output (B,5). Overfit N=32. | Not started |
| 5    | **GBT Model** — Hand-crafted features (§5.4 of spec): OFI, trade imbalance, spread dynamics, etc. XGBoost C API, overfit N=32. | Not started |
| 6    | **CNN Model** — Treat (W,F) as 2D image, conv layers, pool, FC head. Overfit N=32. | Not started |
| 7    | **SSM Model** — Mamba-style selective state space (Python, mamba-ssm). Overfit N=32. Requires CUDA. | Not started |
